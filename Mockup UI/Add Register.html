<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modbus Register Editor - SRT-MGATE-1210</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT:'#2f6f64',
              dark: '#1f4f44',
              light: '#3f8f74',
              ink:'#e7f3f0'
            }
          },
          boxShadow: {
            soft:'0 10px 30px rgba(2,8,20,.08)',
            glow: '0 0 20px rgba(47, 111, 100, 0.3)',
            inner: 'inset 0 2px 4px 0 rgb(0 0 0 / 0.05)'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* JSON Syntax Highlighting */
    .json-key { color: #7dd3fc; font-weight: 500; }
    .json-string { color: #86efac; }
    .json-number { color: #fbbf24; }
    .json-boolean { color: #c084fc; }
    .json-null { color: #f87171; }
    .json-bracket { color: #cbd5e1; font-weight: bold; }

    /* Smooth transitions */
    * { transition: all 0.2s ease; }
    input:focus, select:focus { transform: translateY(-1px); }

    /* Input animation */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .input-shimmer:focus {
      animation: shimmer 3s infinite;
      background: linear-gradient(90deg, transparent 0%, rgba(47, 111, 100, 0.1) 50%, transparent 100%);
      background-size: 1000px 100%;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200 text-slate-800 min-h-screen">

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-800">Modbus Register Editor</h1>
          <p class="text-xs text-slate-500">SRT-MGATE-1210 Configuration</p>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-emerald-50 rounded-lg border border-emerald-200">
        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
        <span class="text-xs font-medium text-emerald-700">Live Preview</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">

      <!-- Form Section -->
      <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span class="w-1 h-6 bg-gradient-to-b from-brand to-brand-dark rounded-full"></span>
              Register Configuration
            </h2>
            <p class="mt-1 text-xs text-slate-500">Fill in the Modbus register details below</p>
          </div>
        </div>

        <form id="registerForm" class="space-y-5">

          <!-- Device ID (read-only) -->
          <div class="group">
            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Device ID
            </label>
            <input id="device_id" type="text" value="D4A5F1" readonly
                   class="w-full rounded-xl border-2 border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600 font-mono shadow-inner cursor-not-allowed" />
          </div>

          <!-- Register Name -->
          <div class="group">
            <label for="reg_name" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              Register Name
              <span class="text-red-500">*</span>
            </label>
            <input id="reg_name" type="text" placeholder="e.g., Voltage_L1, Temperature_Sensor" required
                   class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
          </div>

          <!-- Address -->
          <div class="group">
            <label for="reg_addr" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Modbus Address
              <span class="text-red-500">*</span>
            </label>
            <input id="reg_addr" type="number" min="0" max="65535" placeholder="40001" required
                   class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 font-mono" />
            <p id="addr_err" class="mt-2 hidden text-xs text-red-600 font-medium flex items-center gap-1 animate-slide-up">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              Address must be between 0-65535
            </p>
          </div>

          <!-- Function Code -->
          <div class="group">
            <label for="reg_fc" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              Function Code
              <span class="text-red-500">*</span>
            </label>
            <select id="reg_fc" required
                    class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 bg-white cursor-pointer">
              <option value="1">üìç FC 01: Read Coil Status</option>
              <option value="2">üìç FC 02: Read Discrete Input</option>
              <option value="3" selected>üìç FC 03: Read Holding Register</option>
              <option value="4">üìç FC 04: Read Input Register</option>
            </select>
          </div>

          <!-- Data Type -->
          <div class="group">
            <div class="flex items-center justify-between mb-2">
              <label for="reg_dt" class="block text-sm font-semibold text-slate-700 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
                Data Type
                <span class="text-red-500">*</span>
              </label>
              <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-md">28 types available</span>
            </div>
            <select id="reg_dt" required
                    class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 bg-white cursor-pointer">
              <optgroup label="üîπ 16-bit Signed Integer">
                <option value="INT16">INT16 - Single Register</option>
              </optgroup>
              <optgroup label="üîπ 16-bit Unsigned Integer">
                <option value="UINT16">UINT16 - Single Register</option>
              </optgroup>
              <optgroup label="üîπ Boolean Value">
                <option value="BOOL">BOOL - Single Register</option>
              </optgroup>
              <optgroup label="üîπ Binary Data">
                <option value="BINARY">BINARY - Raw 16-bit Value</option>
              </optgroup>
              <optgroup label="üî∏ 32-bit Signed Integer">
                <option value="INT32_BE">INT32_BE - Big Endian</option>
                <option value="INT32_LE">INT32_LE - Little Endian</option>
                <option value="INT32_BE_BS">INT32_BE_BS - Big Endian + Byte Swap</option>
                <option value="INT32_LE_BS">INT32_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üî∏ 32-bit Unsigned Integer">
                <option value="UINT32_BE">UINT32_BE - Big Endian</option>
                <option value="UINT32_LE">UINT32_LE - Little Endian</option>
                <option value="UINT32_BE_BS">UINT32_BE_BS - Big Endian + Byte Swap</option>
                <option value="UINT32_LE_BS">UINT32_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üî∏ 32-bit IEEE 754 Float">
                <option value="FLOAT32_BE" selected>FLOAT32_BE - Big Endian</option>
                <option value="FLOAT32_LE">FLOAT32_LE - Little Endian</option>
                <option value="FLOAT32_BE_BS">FLOAT32_BE_BS - Big Endian + Byte Swap</option>
                <option value="FLOAT32_LE_BS">FLOAT32_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üî∂ 64-bit Signed Integer">
                <option value="INT64_BE">INT64_BE - Big Endian</option>
                <option value="INT64_LE">INT64_LE - Little Endian</option>
                <option value="INT64_BE_BS">INT64_BE_BS - Big Endian + Byte Swap</option>
                <option value="INT64_LE_BS">INT64_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üî∂ 64-bit Unsigned Integer">
                <option value="UINT64_BE">UINT64_BE - Big Endian</option>
                <option value="UINT64_LE">UINT64_LE - Little Endian</option>
                <option value="UINT64_BE_BS">UINT64_BE_BS - Big Endian + Byte Swap</option>
                <option value="UINT64_LE_BS">UINT64_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üî∂ 64-bit IEEE 754 Double">
                <option value="DOUBLE64_BE">DOUBLE64_BE - Big Endian</option>
                <option value="DOUBLE64_LE">DOUBLE64_LE - Little Endian</option>
                <option value="DOUBLE64_BE_BS">DOUBLE64_BE_BS - Big Endian + Byte Swap</option>
                <option value="DOUBLE64_LE_BS">DOUBLE64_LE_BS - Little Endian + Byte Swap</option>
              </optgroup>
              <optgroup label="üì¶ Legacy Types">
                <option value="INT32">INT32 - Legacy Format</option>
                <option value="FLOAT32">FLOAT32 - Legacy Format</option>
                <option value="STRING">STRING - Variable Length</option>
              </optgroup>
            </select>
            <p class="mt-2 text-xs text-slate-500 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2">
              <span class="font-semibold">üí° Info:</span>
              <span class="font-mono text-blue-700">BE</span> = Big Endian,
              <span class="font-mono text-blue-700">LE</span> = Little Endian,
              <span class="font-mono text-blue-700">_BS</span> = Byte Swap
            </p>
          </div>

          <!-- Description -->
          <div class="group">
            <label for="reg_desc" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
              </svg>
              Description
              <span class="text-slate-400 text-xs">(Optional)</span>
            </label>
            <input id="reg_desc" type="text" placeholder="e.g., Phase 1 Voltage Measurement"
                   class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
          </div>

          <!-- Calibration Section -->
          <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl p-4">
            <h3 class="text-sm font-bold text-amber-900 mb-3 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
              </svg>
              Calibration Settings
              <span class="text-xs font-normal text-amber-700">(Optional)</span>
            </h3>

            <!-- Scale -->
            <div class="mb-3">
              <label for="reg_scale" class="block text-sm font-semibold text-amber-900 mb-2">Scale (Multiplier)</label>
              <input id="reg_scale" type="number" step="any" placeholder="1.0" value="1.0"
                     class="w-full rounded-lg border-2 border-amber-300 bg-white px-4 py-2.5 text-sm outline-none focus:border-amber-500 focus:ring-4 focus:ring-amber-200 font-mono" />
              <p class="mt-1.5 text-xs text-amber-700">
                Multiplier untuk kalibrasi (default: 1.0)
              </p>
            </div>

            <!-- Offset -->
            <div class="mb-3">
              <label for="reg_offset" class="block text-sm font-semibold text-amber-900 mb-2">Offset</label>
              <input id="reg_offset" type="number" step="any" placeholder="0.0" value="0.0"
                     class="w-full rounded-lg border-2 border-amber-300 bg-white px-4 py-2.5 text-sm outline-none focus:border-amber-500 focus:ring-4 focus:ring-amber-200 font-mono" />
              <p class="mt-1.5 text-xs text-amber-700">
                Nilai offset setelah scaling (default: 0.0)
              </p>
            </div>

            <!-- Formula Display -->
            <div class="bg-white/80 backdrop-blur-sm rounded-lg px-4 py-3 border-2 border-amber-300">
              <p class="text-xs font-mono text-amber-900 font-semibold text-center">
                final_value = (raw_value √ó <span class="text-orange-600">scale</span>) + <span class="text-orange-600">offset</span>
              </p>
            </div>
          </div>

          <!-- Unit -->
          <div class="group">
            <label for="reg_unit" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
              </svg>
              Unit
              <span class="text-slate-400 text-xs">(Optional)</span>
            </label>
            <input id="reg_unit" type="text" placeholder="e.g., ¬∞C, V, A, kW, %, Bar"
                   class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
            <p class="mt-2 text-xs text-slate-500">
              Satuan ukuran untuk display (misal: ¬∞C, V, A, kW, %)
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-3 pt-4 border-t-2 border-slate-100">
            <button id="btnSave" type="button" class="flex-1 sm:flex-none rounded-xl bg-gradient-to-r from-brand to-brand-light px-6 py-3 text-sm font-bold text-white shadow-lg hover:shadow-glow hover:scale-105 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              Save Register
            </button>
            <button id="btnCopy" type="button" class="flex-1 sm:flex-none rounded-xl bg-slate-900 px-6 py-3 text-sm font-bold text-white shadow-lg hover:bg-slate-800 hover:scale-105 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Copy JSON
            </button>
          </div>

        </form>
      </div>

      <!-- Preview Section -->
      <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up lg:sticky lg:top-24 h-fit">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span class="w-1 h-6 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded-full"></span>
              Live JSON Preview
            </h2>
            <p class="mt-1 text-xs text-slate-500">Real-time API payload preview</p>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-medium text-emerald-600">Active</span>
          </div>
        </div>

        <div class="relative">
          <!-- JSON Output -->
          <pre id="preview" class="max-h-[600px] overflow-auto rounded-xl bg-gradient-to-br from-slate-900 to-slate-800 p-5 text-[13px] leading-6 shadow-inner border border-slate-700"></pre>

          <!-- Copy Success Indicator -->
          <div id="copySuccess" class="hidden absolute top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 animate-slide-up">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            Copied!
          </div>
        </div>

        <!-- Info Box -->
        <div class="mt-4 bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h4 class="text-sm font-bold text-blue-900 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            API Information
          </h4>
          <div class="space-y-1 text-xs text-blue-800">
            <p><span class="font-semibold">Endpoint:</span> <code class="bg-blue-100 px-2 py-0.5 rounded">POST /api/registers</code></p>
            <p><span class="font-semibold">Method:</span> BLE GATT Characteristic Write</p>
            <p><span class="font-semibold">Format:</span> JSON (application/json)</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-12 pb-8 text-center text-xs text-slate-500">
    <p>SRT-MGATE-1210 Firmware Configuration Tool</p>
    <p class="mt-1">¬© 2024 - Modbus RTU/TCP Gateway</p>
  </footer>

  <script>
    const $ = (q) => document.querySelector(q);
    const preview = $('#preview');
    const addr = $('#reg_addr');
    const addrErr = $('#addr_err');
    const copySuccess = $('#copySuccess');

    // Validation functions
    function validAddr() {
      const v = Number(addr.value);
      const ok = Number.isFinite(v) && v >= 0 && v <= 65535;
      addrErr.classList.toggle('hidden', ok);
      addr.classList.toggle('border-red-500', !ok);
      addr.classList.toggle('border-slate-200', ok);
      return ok;
    }

    function validFields() {
      const addrOk = validAddr();
      return addrOk;
    }

    // Build payload
    function buildPayload() {
      const scale = Number($('#reg_scale').value);
      const offset = Number($('#reg_offset').value);

      return {
        op: "create",
        type: "register",
        device_id: $('#device_id').value,
        config: {
          address: Number($('#reg_addr').value) || 0,
          register_name: $('#reg_name').value || '',
          function_code: Number($('#reg_fc').value),
          data_type: $('#reg_dt').value,
          description: $('#reg_desc').value || '',
          scale: Number.isFinite(scale) ? scale : 1.0,
          offset: Number.isFinite(offset) ? offset : 0.0,
          unit: $('#reg_unit').value || ''
        }
      };
    }

    // JSON Syntax Highlighting
    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    // Render preview
    function render() {
      if (!validFields()) {
        preview.innerHTML = '<span class="text-red-400">‚ö†Ô∏è Please fix validation errors before preview</span>';
        return;
      }

      const payload = buildPayload();
      const jsonStr = JSON.stringify(payload, null, 2);
      const highlighted = syntaxHighlight(jsonStr);

      // Add bracket highlighting
      const final = highlighted
        .replace(/\{/g, '<span class="json-bracket">{</span>')
        .replace(/\}/g, '<span class="json-bracket">}</span>')
        .replace(/\[/g, '<span class="json-bracket">[</span>')
        .replace(/\]/g, '<span class="json-bracket">]</span>');

      preview.innerHTML = final;
    }

    // Live preview
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    // Save button
    $('#btnSave').addEventListener('click', (e) => {
      e.preventDefault();
      if (validFields()) {
        render();
        // Show success animation
        const btn = e.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Saving...';
        setTimeout(() => {
          btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> Saved!';
          setTimeout(() => { btn.innerHTML = originalText; }, 1500);
        }, 1000);
      }
    });

    // Copy button
    $('#btnCopy').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2));

        // Show success indicator
        copySuccess.classList.remove('hidden');
        setTimeout(() => {
          copySuccess.classList.add('hidden');
        }, 2000);

        // Button feedback
        const btn = e.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> Copied!';
        btn.classList.remove('bg-slate-900');
        btn.classList.add('bg-emerald-600');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.add('bg-slate-900');
          btn.classList.remove('bg-emerald-600');
        }, 2000);
      } catch (err) {
        alert('Failed to copy to clipboard');
      }
    });

    // Initialize preview
    render();
  </script>
</body>
</html>
