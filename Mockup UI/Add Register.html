<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Modbus Register - SRT-MGATE-1210</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT:'#2f6f64',
              dark: '#1f4f44',
              light: '#3f8f74',
              ink:'#e7f3f0'
            }
          },
          boxShadow: {
            soft:'0 10px 30px rgba(2,8,20,.08)',
            glow: '0 0 20px rgba(47, 111, 100, 0.3)',
            inner: 'inset 0 2px 4px 0 rgb(0 0 0 / 0.05)'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* JSON Syntax Highlighting */
    .json-key { color: #7dd3fc; font-weight: 500; }
    .json-string { color: #86efac; }
    .json-number { color: #fbbf24; }
    .json-boolean { color: #c084fc; }
    .json-null { color: #f87171; }
    .json-bracket { color: #cbd5e1; font-weight: bold; }

    /* Smooth transitions */
    * { transition: all 0.2s ease; }
    input:focus, select:focus { transform: translateY(-1px); }

    /* Input animation */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .input-shimmer:focus {
      animation: shimmer 3s infinite;
      background: linear-gradient(90deg, transparent 0%, rgba(47, 111, 100, 0.1) 50%, transparent 100%);
      background-size: 1000px 100%;
    }

    /* Data type card hover */
    .datatype-option:hover {
      background: linear-gradient(to right, rgba(47, 111, 100, 0.05), rgba(47, 111, 100, 0.02));
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200 text-slate-800 min-h-screen">

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="btnBack" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all hover:scale-105">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-800">Add Modbus Register</h1>
          <p class="text-xs text-slate-500">Device: <span id="deviceIdHeader" class="font-mono font-semibold">-</span></p>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-emerald-50 rounded-lg border border-emerald-200">
        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
        <span class="text-xs font-medium text-emerald-700">Live Preview</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">

      <!-- Form Section -->
      <div class="space-y-6">
        <!-- Basic Info Card -->
        <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="w-1 h-6 bg-gradient-to-b from-brand to-brand-dark rounded-full"></span>
                Basic Information
              </h2>
              <p class="mt-1 text-xs text-slate-500">Register identification and address</p>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Register Name -->
            <div class="group">
              <label for="regName" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                Register Name
                <span class="text-red-500">*</span>
              </label>
              <input id="regName" type="text" placeholder="e.g., VOLTAGE_L1, TEMP_SENSOR_1" required
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
            </div>

            <!-- Address -->
            <div class="group">
              <label for="regAddr" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Modbus Address
                <span class="text-red-500">*</span>
              </label>
              <input id="regAddr" type="number" min="0" max="65535" placeholder="0-65535" required
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 font-mono" />
              <p id="addrErr" class="mt-2 hidden text-xs text-red-600 font-medium flex items-center gap-1 animate-slide-up">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Address must be between 0-65535
              </p>
            </div>

            <!-- Function Code -->
            <div class="group">
              <label for="regFc" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                Function Code
                <span class="text-red-500">*</span>
              </label>
              <select id="regFc" required
                      class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 bg-white cursor-pointer">
                <option value="1">FC 01 - Read Coil Status</option>
                <option value="2">FC 02 - Read Discrete Input</option>
                <option value="3" selected>FC 03 - Read Holding Register</option>
                <option value="4">FC 04 - Read Input Register</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Data Type Card -->
        <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="w-1 h-6 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full"></span>
                Data Type Configuration
              </h2>
              <p class="mt-1 text-xs text-slate-500">40+ data types with automatic register count</p>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Data Type Search -->
            <div class="group">
              <label for="datatypeSearch" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Search Data Type
              </label>
              <input id="datatypeSearch" type="text" placeholder="Search: INT16, FLOAT32, DOUBLE64..."
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
            </div>

            <!-- Data Type Select -->
            <div class="group">
              <label for="regDatatype" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
                Data Type
                <span class="text-red-500">*</span>
              </label>
              <select id="regDatatype" required
                      class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 bg-white cursor-pointer">
                <optgroup label="üîπ 16-bit (1 register)">
                  <option value="INT16" data-regs="1">INT16 - Signed Integer (-32,768 to 32,767)</option>
                  <option value="UINT16" data-regs="1">UINT16 - Unsigned Integer (0 to 65,535)</option>
                </optgroup>
                <optgroup label="üî∏ 32-bit Signed Integer (2 registers)">
                  <option value="INT32_BE" data-regs="2">INT32_BE - Big Endian (ABCD)</option>
                  <option value="INT32_LE" data-regs="2">INT32_LE - Little Endian (DCBA)</option>
                  <option value="INT32_BE_BS" data-regs="2">INT32_BE_BS - Big Endian + Byte Swap (BADC)</option>
                  <option value="INT32_LE_BS" data-regs="2">INT32_LE_BS - Little Endian + Word Swap (CDAB)</option>
                </optgroup>
                <optgroup label="üî∏ 32-bit Unsigned Integer (2 registers)">
                  <option value="UINT32_BE" data-regs="2">UINT32_BE - Big Endian (ABCD)</option>
                  <option value="UINT32_LE" data-regs="2">UINT32_LE - Little Endian (DCBA)</option>
                  <option value="UINT32_BE_BS" data-regs="2">UINT32_BE_BS - Big Endian + Byte Swap (BADC)</option>
                  <option value="UINT32_LE_BS" data-regs="2">UINT32_LE_BS - Little Endian + Word Swap (CDAB)</option>
                </optgroup>
                <optgroup label="üî∏ 32-bit Float IEEE 754 (2 registers)">
                  <option value="FLOAT32_BE" data-regs="2" selected>FLOAT32_BE - Big Endian (ABCD)</option>
                  <option value="FLOAT32_LE" data-regs="2">FLOAT32_LE - Little Endian (DCBA)</option>
                  <option value="FLOAT32_BE_BS" data-regs="2">FLOAT32_BE_BS - Big Endian + Byte Swap (BADC)</option>
                  <option value="FLOAT32_LE_BS" data-regs="2">FLOAT32_LE_BS - Little Endian + Word Swap (CDAB)</option>
                </optgroup>
                <optgroup label="üî∂ 64-bit Signed Integer (4 registers)">
                  <option value="INT64_BE" data-regs="4">INT64_BE - Big Endian (ABCDEFGH)</option>
                  <option value="INT64_LE" data-regs="4">INT64_LE - Little Endian (HGFEDCBA)</option>
                  <option value="INT64_BE_BS" data-regs="4">INT64_BE_BS - Big Endian + Byte Swap (BADCFEHG)</option>
                  <option value="INT64_LE_BS" data-regs="4">INT64_LE_BS - Little Endian + Word Swap (CDABGHEF)</option>
                </optgroup>
                <optgroup label="üî∂ 64-bit Unsigned Integer (4 registers)">
                  <option value="UINT64_BE" data-regs="4">UINT64_BE - Big Endian (ABCDEFGH)</option>
                  <option value="UINT64_LE" data-regs="4">UINT64_LE - Little Endian (HGFEDCBA)</option>
                  <option value="UINT64_BE_BS" data-regs="4">UINT64_BE_BS - Big Endian + Byte Swap (BADCFEHG)</option>
                  <option value="UINT64_LE_BS" data-regs="4">UINT64_LE_BS - Little Endian + Word Swap (CDABGHEF)</option>
                </optgroup>
                <optgroup label="üî∂ 64-bit Double IEEE 754 (4 registers)">
                  <option value="DOUBLE64_BE" data-regs="4">DOUBLE64_BE - Big Endian (ABCDEFGH)</option>
                  <option value="DOUBLE64_LE" data-regs="4">DOUBLE64_LE - Little Endian (HGFEDCBA)</option>
                  <option value="DOUBLE64_BE_BS" data-regs="4">DOUBLE64_BE_BS - Big Endian + Byte Swap (BADCFEHG)</option>
                  <option value="DOUBLE64_LE_BS" data-regs="4">DOUBLE64_LE_BS - Little Endian + Word Swap (CDABGHEF)</option>
                </optgroup>
              </select>
              <div class="mt-2 flex items-center gap-2 text-xs text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <span><strong>BE</strong>=Big Endian, <strong>LE</strong>=Little Endian, <strong>_BS</strong>=Byte/Word Swap</span>
              </div>
            </div>

            <!-- Quantity (Auto-calculated) -->
            <div class="group">
              <label for="regQuantity" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 0l4 16M6 9h14M4 15h14" />
                </svg>
                Register Quantity
                <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-md ml-2">Auto-calculated</span>
              </label>
              <input id="regQuantity" type="number" min="1" max="4" value="2" readonly
                     class="w-full rounded-xl border-2 border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 font-mono font-semibold shadow-inner cursor-not-allowed" />
              <p class="mt-2 text-xs text-slate-500">
                Number of consecutive registers to read (auto-set based on data type)
              </p>
            </div>
          </div>
        </div>

        <!-- Calibration Card -->
        <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="w-1 h-6 bg-gradient-to-b from-amber-500 to-orange-500 rounded-full"></span>
                Calibration & Unit
              </h2>
              <p class="mt-1 text-xs text-slate-500">Optional scaling and offset adjustment</p>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Scale -->
            <div class="group">
              <label for="regScale" class="block text-sm font-semibold text-slate-700 mb-2">
                Scale (Multiplier)
              </label>
              <input id="regScale" type="number" step="any" placeholder="1.0" value="1.0"
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 font-mono" />
              <p class="mt-1.5 text-xs text-slate-500">
                Multiply raw value by this factor (e.g., 0.1 for 235 ‚Üí 23.5)
              </p>
            </div>

            <!-- Offset -->
            <div class="group">
              <label for="regOffset" class="block text-sm font-semibold text-slate-700 mb-2">
                Offset
              </label>
              <input id="regOffset" type="number" step="any" placeholder="0.0" value="0.0"
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 font-mono" />
              <p class="mt-1.5 text-xs text-slate-500">
                Add this value after scaling (e.g., -273.15 for Kelvin to Celsius)
              </p>
            </div>

            <!-- Formula Display -->
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-4">
              <p class="text-xs font-semibold text-amber-900 mb-2">Formula:</p>
              <p class="text-sm font-mono text-amber-900 font-bold text-center bg-white/70 rounded-lg py-3">
                final_value = (raw_value √ó <span class="text-orange-600" id="scalePreview">1.0</span>) + <span class="text-orange-600" id="offsetPreview">0.0</span>
              </p>
              <div class="mt-3 pt-3 border-t border-amber-300">
                <p class="text-xs font-semibold text-amber-900 mb-1">Example:</p>
                <p class="text-xs text-amber-800 font-mono">
                  Raw: <span class="font-bold">1000</span> ‚Üí Final: <span class="font-bold text-orange-600" id="exampleResult">1000.0</span>
                </p>
              </div>
            </div>

            <!-- Unit -->
            <div class="group">
              <label for="regUnit" class="block text-sm font-semibold text-slate-700 mb-2">
                Unit of Measurement
              </label>
              <input id="regUnit" type="text" placeholder="e.g., ¬∞C, V, A, kW, %, Bar, RPM"
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300" />
              <p class="mt-1.5 text-xs text-slate-500">
                Display unit (appears in dashboard and MQTT payload)
              </p>
            </div>
          </div>
        </div>

        <!-- Advanced Settings Card -->
        <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="w-1 h-6 bg-gradient-to-b from-purple-500 to-purple-600 rounded-full"></span>
                Advanced Settings
              </h2>
              <p class="mt-1 text-xs text-slate-500">Optional refresh rate override and description</p>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Refresh Rate Override -->
            <div class="group">
              <div class="flex items-center justify-between mb-2">
                <label for="regRefreshRate" class="block text-sm font-semibold text-slate-700 flex items-center gap-2">
                  <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Refresh Rate Override
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input id="enableRefreshOverride" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-brand focus:ring-brand" />
                  <span class="text-xs text-slate-600">Enable</span>
                </label>
              </div>
              <input id="regRefreshRate" type="number" min="100" step="100" placeholder="1000" disabled
                     class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 font-mono disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed" />
              <p class="mt-1.5 text-xs text-slate-500">
                Override device refresh rate for this register only (milliseconds). Leave unchecked to use device default.
              </p>
            </div>

            <!-- Description -->
            <div class="group">
              <label for="regDesc" class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
                Description
              </label>
              <textarea id="regDesc" rows="3" placeholder="Optional description or notes..."
                        class="input-shimmer w-full rounded-xl border-2 border-slate-200 px-4 py-3 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-brand/20 hover:border-slate-300 resize-none"></textarea>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up">
          <div class="flex flex-wrap gap-3">
            <button id="btnSave" type="button" class="flex-1 sm:flex-none rounded-xl bg-gradient-to-r from-brand to-brand-light px-6 py-3 text-sm font-bold text-white shadow-lg hover:shadow-glow hover:scale-105 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              Save Register
            </button>
            <button id="btnCopy" type="button" class="flex-1 sm:flex-none rounded-xl bg-slate-900 px-6 py-3 text-sm font-bold text-white shadow-lg hover:bg-slate-800 hover:scale-105 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Copy JSON
            </button>
          </div>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="rounded-2xl bg-white p-6 shadow-soft border border-slate-200 animate-slide-up lg:sticky lg:top-24 h-fit">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span class="w-1 h-6 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded-full"></span>
              Live JSON Preview
            </h2>
            <p class="mt-1 text-xs text-slate-500">Real-time BLE API payload</p>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-medium text-emerald-600">Active</span>
          </div>
        </div>

        <div class="relative">
          <!-- JSON Output -->
          <pre id="preview" class="max-h-[600px] overflow-auto rounded-xl bg-gradient-to-br from-slate-900 to-slate-800 p-5 text-[13px] leading-6 shadow-inner border border-slate-700"></pre>

          <!-- Copy Success Indicator -->
          <div id="copySuccess" class="hidden absolute top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 animate-slide-up">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            Copied!
          </div>
        </div>

        <!-- Info Box -->
        <div class="mt-4 bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h4 class="text-sm font-bold text-blue-900 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            BLE API Information
          </h4>
          <div class="space-y-1 text-xs text-blue-800">
            <p><span class="font-semibold">Operation:</span> <code class="bg-blue-100 px-2 py-0.5 rounded">create</code></p>
            <p><span class="font-semibold">Type:</span> <code class="bg-blue-100 px-2 py-0.5 rounded">register</code></p>
            <p><span class="font-semibold">Method:</span> BLE GATT Characteristic Write</p>
            <p><span class="font-semibold">Format:</span> JSON (application/json)</p>
          </div>
        </div>

        <!-- Register Count Info -->
        <div class="mt-4 bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
          <h4 class="text-sm font-bold text-amber-900 mb-2 flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            Register Allocation
          </h4>
          <div class="space-y-1 text-xs text-amber-800">
            <p><span class="font-semibold">Starting Address:</span> <span id="infoAddr" class="font-mono">-</span></p>
            <p><span class="font-semibold">Register Count:</span> <span id="infoQty" class="font-mono">-</span></p>
            <p><span class="font-semibold">Address Range:</span> <span id="infoRange" class="font-mono">-</span></p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-12 pb-8 text-center text-xs text-slate-500">
    <p>SRT-MGATE-1210 Firmware v2.3.0 Configuration Tool</p>
    <p class="mt-1">¬© 2025 - Modbus RTU/TCP Gateway</p>
  </footer>

  <script>
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);

    // Get device_id from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('device_id') || 'UNKNOWN';
    $('#deviceIdHeader').textContent = deviceId;

    // Elements
    const preview = $('#preview');
    const regAddr = $('#regAddr');
    const addrErr = $('#addrErr');
    const copySuccess = $('#copySuccess');
    const regDatatype = $('#regDatatype');
    const regQuantity = $('#regQuantity');
    const regScale = $('#regScale');
    const regOffset = $('#regOffset');
    const scalePreview = $('#scalePreview');
    const offsetPreview = $('#offsetPreview');
    const exampleResult = $('#exampleResult');
    const datatypeSearch = $('#datatypeSearch');
    const enableRefreshOverride = $('#enableRefreshOverride');
    const regRefreshRate = $('#regRefreshRate');

    // Info elements
    const infoAddr = $('#infoAddr');
    const infoQty = $('#infoQty');
    const infoRange = $('#infoRange');

    // Back button
    $('#btnBack').addEventListener('click', () => {
      window.location.href = `Device Details.html?device_id=${deviceId}`;
    });

    // Data type search filter
    datatypeSearch.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const options = regDatatype.querySelectorAll('option');

      options.forEach(opt => {
        const text = opt.textContent.toLowerCase();
        const value = opt.value.toLowerCase();
        const match = text.includes(searchTerm) || value.includes(searchTerm);
        opt.style.display = match ? '' : 'none';
      });
    });

    // Auto-update quantity based on data type
    regDatatype.addEventListener('change', () => {
      const selectedOption = regDatatype.selectedOptions[0];
      const regs = selectedOption.getAttribute('data-regs');
      regQuantity.value = regs || '1';
      updateInfoPanel();
      render();
    });

    // Refresh rate override toggle
    enableRefreshOverride.addEventListener('change', () => {
      regRefreshRate.disabled = !enableRefreshOverride.checked;
      if (!enableRefreshOverride.checked) {
        regRefreshRate.value = '';
      }
      render();
    });

    // Update calibration preview
    function updateCalibrationPreview() {
      const scale = parseFloat(regScale.value) || 1.0;
      const offset = parseFloat(regOffset.value) || 0.0;

      scalePreview.textContent = scale.toFixed(2);
      offsetPreview.textContent = offset.toFixed(2);

      const exampleRaw = 1000;
      const exampleFinal = (exampleRaw * scale) + offset;
      exampleResult.textContent = exampleFinal.toFixed(2);
    }

    regScale.addEventListener('input', updateCalibrationPreview);
    regOffset.addEventListener('input', updateCalibrationPreview);

    // Update info panel
    function updateInfoPanel() {
      const addr = parseInt(regAddr.value) || 0;
      const qty = parseInt(regQuantity.value) || 1;

      infoAddr.textContent = addr;
      infoQty.textContent = qty;
      infoRange.textContent = `${addr} - ${addr + qty - 1}`;
    }

    regAddr.addEventListener('input', updateInfoPanel);

    // Validation functions
    function validAddr() {
      const v = Number(regAddr.value);
      const ok = Number.isFinite(v) && v >= 0 && v <= 65535;
      addrErr.classList.toggle('hidden', ok || regAddr.value === '');
      regAddr.classList.toggle('border-red-500', !ok && regAddr.value !== '');
      regAddr.classList.toggle('border-slate-200', ok || regAddr.value === '');
      return ok;
    }

    function validFields() {
      const addrOk = validAddr();
      const nameOk = $('#regName').value.trim() !== '';
      return addrOk && nameOk;
    }

    // Build payload
    function buildPayload() {
      const scale = Number(regScale.value);
      const offset = Number(regOffset.value);
      const refreshOverride = enableRefreshOverride.checked;
      const refreshRate = refreshOverride ? parseInt(regRefreshRate.value) : null;

      const config = {
        address: Number(regAddr.value) || 0,
        register_name: $('#regName').value || '',
        function_code: Number($('#regFc').value),
        data_type: regDatatype.value,
        quantity: Number(regQuantity.value),
        description: $('#regDesc').value || '',
        unit: $('#regUnit').value || ''
      };

      // Add calibration if not default
      if (scale !== 1.0 || offset !== 0.0) {
        config.calibration = {
          scale: Number.isFinite(scale) ? scale : 1.0,
          offset: Number.isFinite(offset) ? offset : 0.0
        };
      }

      // Add refresh rate override if enabled
      if (refreshOverride && refreshRate) {
        config.refresh_rate_ms = refreshRate;
      }

      return {
        op: "create",
        type: "register",
        device_id: deviceId,
        config: config
      };
    }

    // JSON Syntax Highlighting
    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    // Render preview
    function render() {
      if (!validFields()) {
        preview.innerHTML = '<span class="text-red-400">‚ö†Ô∏è Please fill all required fields</span>';
        return;
      }

      const payload = buildPayload();
      const jsonStr = JSON.stringify(payload, null, 2);
      const highlighted = syntaxHighlight(jsonStr);

      // Add bracket highlighting
      const final = highlighted
        .replace(/\{/g, '<span class="json-bracket">{</span>')
        .replace(/\}/g, '<span class="json-bracket">}</span>')
        .replace(/\[/g, '<span class="json-bracket">[</span>')
        .replace(/\]/g, '<span class="json-bracket">]</span>');

      preview.innerHTML = final;
    }

    // Live preview
    $$('input, select, textarea').forEach(el => {
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    // Save button
    $('#btnSave').addEventListener('click', async (e) => {
      e.preventDefault();
      if (!validFields()) {
        alert('Please fill all required fields');
        return;
      }

      const btn = e.target.closest('button');
      const originalText = btn.innerHTML;

      btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Saving...';
      btn.disabled = true;

      // Simulate BLE save operation
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Get device from localStorage
      const devices = JSON.parse(localStorage.getItem('mockDevices') || '[]');
      const deviceIndex = devices.findIndex(d => d.device_id === deviceId);

      if (deviceIndex !== -1) {
        // Add register to device
        const payload = buildPayload();
        if (!devices[deviceIndex].registers) {
          devices[deviceIndex].registers = [];
        }
        devices[deviceIndex].registers.push(payload.config);
        localStorage.setItem('mockDevices', JSON.stringify(devices));

        btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> Saved!';

        setTimeout(() => {
          window.location.href = `Device Details.html?device_id=${deviceId}`;
        }, 1500);
      } else {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Device not found');
      }
    });

    // Copy button
    $('#btnCopy').addEventListener('click', async (e) => {
      e.preventDefault();
      if (!validFields()) {
        alert('Please fill all required fields');
        return;
      }

      try {
        await navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2));

        // Show success indicator
        copySuccess.classList.remove('hidden');
        setTimeout(() => {
          copySuccess.classList.add('hidden');
        }, 2000);

        // Button feedback
        const btn = e.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> Copied!';
        btn.classList.remove('bg-slate-900');
        btn.classList.add('bg-emerald-600');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.add('bg-slate-900');
          btn.classList.remove('bg-emerald-600');
        }, 2000);
      } catch (err) {
        alert('Failed to copy to clipboard');
      }
    });

    // Initialize
    updateCalibrationPreview();
    updateInfoPanel();
    render();
  </script>
</body>
</html>
