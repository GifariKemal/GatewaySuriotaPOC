<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create New Device - Multi-Step Wizard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{ extend:{
        colors:{ brand:{ DEFAULT:'#2f6f64' } },
        boxShadow:{ soft:'0 10px 30px rgba(2,8,20,.08)' },
        animation: {
          'slide-in-right': 'slideInRight 0.3s ease-out',
          'slide-in-left': 'slideInLeft 0.3s ease-out',
        },
        keyframes: {
          slideInRight: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
          slideInLeft: { '0%': { transform: 'translateX(-100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
        }
      }}
    }
  </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="Device List (Home Screen).html" class="font-semibold text-slate-900 flex items-center gap-2 hover:text-brand transition">
        <svg class="size-5" fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        Back to List
      </a>
      <h1 class="text-lg font-bold text-brand">Create New Device</h1>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4">
    <!-- Progress Steps -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
      <div class="flex items-center justify-between">
        <div class="step-item flex-1 flex flex-col items-center active">
          <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm">1</div>
          <span class="text-xs mt-2 font-semibold">Basic Info</span>
        </div>
        <div class="flex-1 h-0.5 bg-slate-200"></div>
        <div class="step-item flex-1 flex flex-col items-center">
          <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm">2</div>
          <span class="text-xs mt-2 font-semibold">Protocol Settings</span>
        </div>
        <div class="flex-1 h-0.5 bg-slate-200"></div>
        <div class="step-item flex-1 flex flex-col items-center">
          <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm">3</div>
          <span class="text-xs mt-2 font-semibold">Review & Save</span>
        </div>
      </div>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-soft p-6">
      <!-- Step 1: Basic Info -->
      <div id="step1" class="step-content">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Step 1: Basic Information</h2>

        <div class="space-y-4">
          <div>
            <label for="deviceName" class="block text-sm font-semibold text-slate-700 mb-2">Device Name *</label>
            <input id="deviceName" type="text" placeholder="e.g., Main Power Meter" required
                   class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            <p class="text-xs text-slate-500 mt-1">A descriptive name for this device</p>
          </div>

          <div>
            <label for="deviceId" class="block text-sm font-semibold text-slate-700 mb-2">Device ID *</label>
            <div class="flex gap-2">
              <input id="deviceId" type="text" placeholder="Auto-generated" maxlength="6"
                     class="flex-1 rounded-xl border border-slate-200 px-4 py-2.5 text-sm font-mono outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
              <button id="btnGenerateId" class="px-4 py-2.5 rounded-xl bg-slate-200 text-slate-700 font-semibold hover:bg-slate-300 transition">
                Generate
              </button>
            </div>
            <p id="deviceIdError" class="text-xs text-red-600 mt-1 hidden">Device ID must be 6 characters (A-F, 0-9)</p>
            <p id="deviceIdDuplicate" class="text-xs text-red-600 mt-1 hidden">This Device ID already exists!</p>
          </div>

          <div>
            <label for="protocol" class="block text-sm font-semibold text-slate-700 mb-2">Protocol *</label>
            <div class="grid grid-cols-2 gap-3">
              <label class="protocol-card cursor-pointer rounded-xl border-2 p-4 transition hover:border-emerald-500 active">
                <input type="radio" name="protocol" value="RTU" class="sr-only" checked>
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                      <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-bold text-slate-900">RTU</p>
                    <p class="text-xs text-slate-500">Serial RS485</p>
                  </div>
                </div>
              </label>
              <label class="protocol-card cursor-pointer rounded-xl border-2 p-4 transition hover:border-blue-500">
                <input type="radio" name="protocol" value="TCP" class="sr-only">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                  </div>
                  <div>
                    <p class="font-bold text-slate-900">TCP</p>
                    <p class="text-xs text-slate-500">Ethernet/WiFi</p>
                  </div>
                </div>
              </label>
            </div>
          </div>

          <div>
            <label class="flex items-center gap-3 cursor-pointer">
              <input id="enabledToggle" type="checkbox" checked class="sr-only peer">
              <div class="relative w-11 h-6 rounded-full bg-slate-300 peer-checked:bg-emerald-500 transition">
                <div class="absolute top-1 left-1 w-4 h-4 rounded-full bg-white transition-transform peer-checked:translate-x-5"></div>
              </div>
              <span class="text-sm font-semibold text-slate-700">Enable device after creation</span>
            </label>
            <p class="text-xs text-slate-500 mt-1 ml-14">Device will start polling immediately</p>
          </div>
        </div>

        <div class="mt-6 flex justify-end">
          <button id="btnNext1" class="px-6 py-2.5 rounded-xl bg-brand text-white font-semibold hover:brightness-110 transition">
            Next: Protocol Settings →
          </button>
        </div>
      </div>

      <!-- Step 2: Protocol Settings -->
      <div id="step2" class="step-content hidden">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Step 2: Protocol Settings</h2>

        <!-- RTU Settings -->
        <div id="rtuSettings" class="space-y-4">
          <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-4">
            <h3 class="font-semibold text-emerald-900 mb-2">RTU (Modbus Serial) Configuration</h3>
            <p class="text-sm text-emerald-700">Configure RS485 serial communication parameters</p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="slaveId" class="block text-sm font-semibold text-slate-700 mb-2">Slave ID *</label>
              <input id="slaveId" type="number" min="1" max="247" value="1" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
              <p id="slaveIdError" class="text-xs text-red-600 mt-1 hidden">Slave ID must be 1-247</p>
            </div>

            <div>
              <label for="serialPort" class="block text-sm font-semibold text-slate-700 mb-2">Serial Port *</label>
              <select id="serialPort" required
                      class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition">
                <option value="1">Port 1 (RS485-1)</option>
                <option value="2">Port 2 (RS485-2)</option>
              </select>
            </div>

            <div>
              <label for="baudRate" class="block text-sm font-semibold text-slate-700 mb-2">Baud Rate *</label>
              <select id="baudRate" required
                      class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition">
                <option value="1200">1200</option>
                <option value="2400">2400</option>
                <option value="4800">4800</option>
                <option value="9600" selected>9600</option>
                <option value="19200">19200</option>
                <option value="38400">38400</option>
                <option value="57600">57600</option>
                <option value="115200">115200</option>
              </select>
            </div>

            <div>
              <label for="timeout" class="block text-sm font-semibold text-slate-700 mb-2">Timeout (ms) *</label>
              <input id="timeout" type="number" min="100" max="10000" value="3000" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>

            <div>
              <label for="retryCount" class="block text-sm font-semibold text-slate-700 mb-2">Max Retries *</label>
              <input id="retryCount" type="number" min="0" max="10" value="3" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>

            <div>
              <label for="refreshRateRtu" class="block text-sm font-semibold text-slate-700 mb-2">Refresh Rate (ms) *</label>
              <input id="refreshRateRtu" type="number" min="100" max="60000" value="5000" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>
          </div>
        </div>

        <!-- TCP Settings -->
        <div id="tcpSettings" class="space-y-4 hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
            <h3 class="font-semibold text-blue-900 mb-2">TCP (Modbus Ethernet) Configuration</h3>
            <p class="text-sm text-blue-700">Configure Ethernet/WiFi connection parameters</p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="ipAddress" class="block text-sm font-semibold text-slate-700 mb-2">IP Address *</label>
              <input id="ipAddress" type="text" placeholder="192.168.1.100" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm font-mono outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
              <p id="ipError" class="text-xs text-red-600 mt-1 hidden">Invalid IP address format</p>
            </div>

            <div>
              <label for="tcpPort" class="block text-sm font-semibold text-slate-700 mb-2">TCP Port *</label>
              <input id="tcpPort" type="number" min="1" max="65535" value="502" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>

            <div>
              <label for="timeoutTcp" class="block text-sm font-semibold text-slate-700 mb-2">Timeout (ms) *</label>
              <input id="timeoutTcp" type="number" min="100" max="10000" value="5000" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>

            <div>
              <label for="retryCountTcp" class="block text-sm font-semibold text-slate-700 mb-2">Max Retries *</label>
              <input id="retryCountTcp" type="number" min="0" max="10" value="3" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>

            <div class="sm:col-span-2">
              <label for="refreshRateTcp" class="block text-sm font-semibold text-slate-700 mb-2">Refresh Rate (ms) *</label>
              <input id="refreshRateTcp" type="number" min="100" max="60000" value="10000" required
                     class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-brand focus:ring-4 focus:ring-emerald-200 transition"/>
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-between">
          <button id="btnBack2" class="px-6 py-2.5 rounded-xl border-2 border-slate-300 text-slate-700 font-semibold hover:bg-slate-50 transition">
            ← Back
          </button>
          <button id="btnNext2" class="px-6 py-2.5 rounded-xl bg-brand text-white font-semibold hover:brightness-110 transition">
            Next: Review →
          </button>
        </div>
      </div>

      <!-- Step 3: Review & Save -->
      <div id="step3" class="step-content hidden">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Step 3: Review & Save</h2>

        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
          <p class="text-sm text-blue-900">
            <strong>Review your configuration</strong> before saving. You can edit device settings later from the device details page.
          </p>
        </div>

        <!-- Preview Card -->
        <div class="bg-white border-2 border-slate-200 rounded-xl p-6 space-y-4">
          <div>
            <h3 class="text-sm font-semibold text-slate-500 mb-2">Device Information</h3>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div>
                <dt class="text-slate-600">Device Name:</dt>
                <dd id="reviewName" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Device ID:</dt>
                <dd id="reviewId" class="font-mono font-semibold text-brand">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Protocol:</dt>
                <dd id="reviewProtocol" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Status:</dt>
                <dd id="reviewEnabled" class="font-semibold">-</dd>
              </div>
            </dl>
          </div>

          <div id="reviewRtuSection">
            <h3 class="text-sm font-semibold text-slate-500 mb-2">RTU Configuration</h3>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div>
                <dt class="text-slate-600">Slave ID:</dt>
                <dd id="reviewSlaveId" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Serial Port:</dt>
                <dd id="reviewPort" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Baud Rate:</dt>
                <dd id="reviewBaud" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Timeout:</dt>
                <dd id="reviewTimeout" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Max Retries:</dt>
                <dd id="reviewRetry" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Refresh Rate:</dt>
                <dd id="reviewRefresh" class="font-semibold text-slate-900">-</dd>
              </div>
            </dl>
          </div>

          <div id="reviewTcpSection" class="hidden">
            <h3 class="text-sm font-semibold text-slate-500 mb-2">TCP Configuration</h3>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              <div>
                <dt class="text-slate-600">IP Address:</dt>
                <dd id="reviewIp" class="font-mono font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">TCP Port:</dt>
                <dd id="reviewTcpPort" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Timeout:</dt>
                <dd id="reviewTimeoutTcp" class="font-semibold text-slate-900">-</dd>
              </div>
              <div>
                <dt class="text-slate-600">Max Retries:</dt>
                <dd id="reviewRetryTcp" class="font-semibold text-slate-900">-</dd>
              </div>
              <div class="sm:col-span-2">
                <dt class="text-slate-600">Refresh Rate:</dt>
                <dd id="reviewRefreshTcp" class="font-semibold text-slate-900">-</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- JSON Preview -->
        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-slate-700">JSON Configuration</h3>
            <button id="btnCopyJson" class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-xs font-semibold hover:bg-slate-800 transition">
              Copy JSON
            </button>
          </div>
          <pre id="jsonPreview" class="max-h-60 overflow-auto rounded-xl bg-slate-900 p-4 text-xs text-emerald-100 font-mono"></pre>
        </div>

        <div class="mt-6 flex justify-between">
          <button id="btnBack3" class="px-6 py-2.5 rounded-xl border-2 border-slate-300 text-slate-700 font-semibold hover:bg-slate-50 transition">
            ← Back
          </button>
          <button id="btnSave" class="px-6 py-2.5 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Save Device
          </button>
        </div>
      </div>
    </div>
  </main>

  <style>
    .step-item.active .step-circle {
      background: #2f6f64;
      color: white;
    }
    .step-item:not(.active) .step-circle {
      background: #e2e8f0;
      color: #64748b;
    }
    .step-item.completed .step-circle {
      background: #10b981;
      color: white;
    }
    .protocol-card.active {
      border-color: #2f6f64;
      background: #f0fdfa;
    }
    #enabledToggle:checked + div {
      background: #10b981;
    }
    #enabledToggle:checked + div > div {
      transform: translateX(1.25rem);
    }
  </style>

  <script>
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);

    // State
    let currentStep = 1;
    const formData = {
      device_name: '',
      device_id: '',
      protocol: 'RTU',
      enabled: true,
      // RTU
      slave_id: 1,
      serial_port: 1,
      baud_rate: 9600,
      timeout_ms: 3000,
      retry_count: 3,
      refresh_rate_ms: 5000,
      // TCP
      ip_address: '',
      port: 502,
      registers: [],
      metrics: {
        total_reads: 0,
        successful_reads: 0,
        failed_reads: 0,
        success_rate: 0,
        avg_response_time_ms: 0,
        min_response_time_ms: 0,
        max_response_time_ms: 0
      },
      disable_reason: 'NONE',
      disable_reason_detail: ''
    };

    // Navigation
    function showStep(step) {
      $$('.step-content').forEach(el => el.classList.add('hidden'));
      $(`#step${step}`).classList.remove('hidden');

      $$('.step-item').forEach((el, idx) => {
        el.classList.remove('active', 'completed');
        if (idx + 1 < step) el.classList.add('completed');
        if (idx + 1 === step) el.classList.add('active');
      });

      currentStep = step;
      if (step === 3) updateReview();
    }

    // Generate Device ID
    function generateDeviceId() {
      return Array.from({ length: 6 }, () =>
        '0123456789ABCDEF'[Math.floor(Math.random() * 16)]
      ).join('');
    }

    $('#btnGenerateId').addEventListener('click', () => {
      $('#deviceId').value = generateDeviceId();
      validateDeviceId();
    });

    // Validation
    function validateDeviceId() {
      const id = $('#deviceId').value.trim().toUpperCase();
      const valid = /^[0-9A-F]{6}$/.test(id);
      $('#deviceIdError').classList.toggle('hidden', valid || id === '');

      if (valid) {
        const devices = JSON.parse(localStorage.getItem('mockDevices') || '[]');
        const duplicate = devices.some(d => d.device_id === id);
        $('#deviceIdDuplicate').classList.toggle('hidden', !duplicate);
        return !duplicate;
      }
      return false;
    }

    $('#deviceId').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
      validateDeviceId();
    });

    function validateSlaveId() {
      const val = Number($('#slaveId').value);
      const valid = val >= 1 && val <= 247;
      $('#slaveIdError').classList.toggle('hidden', valid);
      return valid;
    }

    $('#slaveId').addEventListener('input', validateSlaveId);

    function validateIP() {
      const ip = $('#ipAddress').value.trim();
      const valid = /^((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/.test(ip);
      $('#ipError').classList.toggle('hidden', valid || ip === '');
      return valid;
    }

    $('#ipAddress').addEventListener('input', validateIP);

    // Protocol Selection
    $$('input[name="protocol"]').forEach(radio => {
      radio.addEventListener('change', () => {
        $$('.protocol-card').forEach(card => card.classList.remove('active'));
        radio.closest('.protocol-card').classList.add('active');
        formData.protocol = radio.value;

        // Toggle settings visibility
        const isRTU = radio.value === 'RTU';
        $('#rtuSettings').classList.toggle('hidden', !isRTU);
        $('#tcpSettings').classList.toggle('hidden', isRTU);
      });
    });

    // Step Navigation
    $('#btnNext1').addEventListener('click', () => {
      // Validate Step 1
      const name = $('#deviceName').value.trim();
      const id = $('#deviceId').value.trim();

      if (!name) {
        alert('Please enter a device name');
        return;
      }
      if (!id || !validateDeviceId()) {
        alert('Please enter a valid Device ID (6 characters, A-F and 0-9)');
        return;
      }

      formData.device_name = name;
      formData.device_id = id;
      formData.enabled = $('#enabledToggle').checked;

      showStep(2);
    });

    $('#btnNext2').addEventListener('click', () => {
      // Validate Step 2
      if (formData.protocol === 'RTU') {
        if (!validateSlaveId()) {
          alert('Please enter a valid Slave ID (1-247)');
          return;
        }
        formData.slave_id = Number($('#slaveId').value);
        formData.serial_port = Number($('#serialPort').value);
        formData.baud_rate = Number($('#baudRate').value);
        formData.timeout_ms = Number($('#timeout').value);
        formData.retry_count = Number($('#retryCount').value);
        formData.refresh_rate_ms = Number($('#refreshRateRtu').value);
      } else {
        if (!validateIP()) {
          alert('Please enter a valid IP address');
          return;
        }
        formData.ip_address = $('#ipAddress').value.trim();
        formData.port = Number($('#tcpPort').value);
        formData.timeout_ms = Number($('#timeoutTcp').value);
        formData.retry_count = Number($('#retryCountTcp').value);
        formData.refresh_rate_ms = Number($('#refreshRateTcp').value);
      }

      showStep(3);
    });

    $('#btnBack2').addEventListener('click', () => showStep(1));
    $('#btnBack3').addEventListener('click', () => showStep(2));

    // Review
    function updateReview() {
      $('#reviewName').textContent = formData.device_name;
      $('#reviewId').textContent = formData.device_id;
      $('#reviewProtocol').textContent = formData.protocol;
      $('#reviewEnabled').textContent = formData.enabled ? '✅ Enabled' : '❌ Disabled';
      $('#reviewEnabled').className = formData.enabled ? 'font-semibold text-emerald-600' : 'font-semibold text-slate-600';

      if (formData.protocol === 'RTU') {
        $('#reviewRtuSection').classList.remove('hidden');
        $('#reviewTcpSection').classList.add('hidden');
        $('#reviewSlaveId').textContent = formData.slave_id;
        $('#reviewPort').textContent = `Port ${formData.serial_port}`;
        $('#reviewBaud').textContent = `${formData.baud_rate} bps`;
        $('#reviewTimeout').textContent = `${formData.timeout_ms} ms`;
        $('#reviewRetry').textContent = formData.retry_count;
        $('#reviewRefresh').textContent = `${formData.refresh_rate_ms} ms`;
      } else {
        $('#reviewRtuSection').classList.add('hidden');
        $('#reviewTcpSection').classList.remove('hidden');
        $('#reviewIp').textContent = formData.ip_address;
        $('#reviewTcpPort').textContent = formData.port;
        $('#reviewTimeoutTcp').textContent = `${formData.timeout_ms} ms`;
        $('#reviewRetryTcp').textContent = formData.retry_count;
        $('#reviewRefreshTcp').textContent = `${formData.refresh_rate_ms} ms`;
      }

      $('#jsonPreview').textContent = JSON.stringify(formData, null, 2);
    }

    $('#btnCopyJson').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText($('#jsonPreview').textContent);
        $('#btnCopyJson').textContent = '✓ Copied!';
        setTimeout(() => $('#btnCopyJson').textContent = 'Copy JSON', 2000);
      } catch (e) {
        alert('Failed to copy');
      }
    });

    // Save
    $('#btnSave').addEventListener('click', () => {
      const devices = JSON.parse(localStorage.getItem('mockDevices') || '[]');
      devices.push(formData);
      localStorage.setItem('mockDevices', JSON.stringify(devices));

      alert(`✅ Device "${formData.device_name}" created successfully!\n\nDevice ID: ${formData.device_id}\nProtocol: ${formData.protocol}`);
      window.location.href = 'Device List (Home Screen).html';
    });

    // Init
    $('#deviceId').value = generateDeviceId();
  </script>
</body>
</html>
